import{Loader as e,LoaderUtils as t,FileLoader as r,Color as s,SpotLight as a,PointLight as n,DirectionalLight as o,MeshBasicMaterial as i,MeshPhysicalMaterial as l,Vector2 as c,MeshStandardMaterial as u,TangentSpaceNormalMap as p,TextureLoader as h,InterleavedBuffer as d,BufferAttribute as m,LinearFilter as f,LinearMipmapLinearFilter as g,RepeatWrapping as v,RGBFormat as T,PointsMaterial as y,Material as S,LineBasicMaterial as M,DoubleSide as R,sRGBEncoding as x,BufferGeometry as _,SkinnedMesh as A,Mesh as E,LineSegments as w,Line as L,LineLoop as b,Points as I,Group as P,PerspectiveCamera as O,Math as C,OrthographicCamera as H,InterpolateLinear as U,AnimationClip as N,Bone as F,Object3D as D,PropertyBinding as G,Matrix4 as k,Skeleton as K,Interpolant as j,NearestFilter as B,NearestMipmapNearestFilter as V,LinearMipmapNearestFilter as X,NearestMipmapLinearFilter as z,ClampToEdgeWrapping as W,MirroredRepeatWrapping as Y,InterpolateDiscrete as Z,RGBAFormat as q,FrontSide as J,InterleavedBufferAttribute as Q,TriangleFanDrawMode as $,TriangleStripDrawMode as ee,VectorKeyframeTrack as te,QuaternionKeyframeTrack as re,NumberKeyframeTrack as se,Vector3 as ae,Box3 as ne,Sphere as oe}from"../../../../three.js";var ie=function(){function ie(t){e.call(this,t),this.dracoLoader=null,this.ddsLoader=null}function le(){var e={};return{get:function(t){return e[t]},add:function(t,r){e[t]=r},remove:function(t){delete e[t]},removeAll:function(){e={}}}}ie.prototype=Object.assign(Object.create(e.prototype),{constructor:ie,load:function(e,s,a,n){var o,i=this;o=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:t.extractUrlBase(e),i.manager.itemStart(e);var l=function(t){n?n(t):console.error(t),i.manager.itemError(e),i.manager.itemEnd(e)},c=new r(i.manager);c.setPath(this.path),c.setResponseType("arraybuffer"),"use-credentials"===i.crossOrigin&&c.setWithCredentials(!0),c.load(e,(function(t){try{i.parse(t,o,(function(t){s(t),i.manager.itemEnd(e)}),l)}catch(e){l(e)}}),a,l)},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(e){return this.ddsLoader=e,this},parse:function(e,r,s,a){var n,o={};if("string"==typeof e)n=e;else if(t.decodeText(new Uint8Array(e,0,4))===me){try{o[ce.KHR_BINARY_GLTF]=new ve(e)}catch(e){return void(a&&a(e))}n=o[ce.KHR_BINARY_GLTF].content}else n=t.decodeText(new Uint8Array(e));var i=JSON.parse(n);if(void 0===i.asset||i.asset.version[0]<2)a&&a(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{if(i.extensionsUsed)for(var l=0;l<i.extensionsUsed.length;++l){var c=i.extensionsUsed[l],u=i.extensionsRequired||[];switch(c){case ce.KHR_LIGHTS_PUNCTUAL:o[c]=new pe(i);break;case ce.KHR_MATERIALS_CLEARCOAT:o[c]=new de;break;case ce.KHR_MATERIALS_UNLIT:o[c]=new he;break;case ce.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:o[c]=new Me;break;case ce.KHR_DRACO_MESH_COMPRESSION:o[c]=new Te(i,this.dracoLoader);break;case ce.MSFT_TEXTURE_DDS:o[c]=new ue(this.ddsLoader);break;case ce.KHR_TEXTURE_TRANSFORM:o[c]=new ye;break;case ce.KHR_MESH_QUANTIZATION:o[c]=new Re;break;default:u.indexOf(c)>=0&&console.warn('THREE.GLTFLoader: Unknown extension "'+c+'".')}}new We(i,o,{path:r||this.resourcePath||"",crossOrigin:this.crossOrigin,manager:this.manager}).parse(s,a)}}});var ce={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",MSFT_TEXTURE_DDS:"MSFT_texture_dds"};function ue(e){if(!e)throw new Error("THREE.GLTFLoader: Attempting to load .dds texture without importing DDSLoader");this.name=ce.MSFT_TEXTURE_DDS,this.ddsLoader=e}function pe(e){this.name=ce.KHR_LIGHTS_PUNCTUAL;var t=e.extensions&&e.extensions[ce.KHR_LIGHTS_PUNCTUAL]||{};this.lightDefs=t.lights||[]}function he(){this.name=ce.KHR_MATERIALS_UNLIT}function de(){this.name=ce.KHR_MATERIALS_CLEARCOAT}pe.prototype.loadLight=function(e){var t,r=this.lightDefs[e],i=new s(16777215);void 0!==r.color&&i.fromArray(r.color);var l=void 0!==r.range?r.range:0;switch(r.type){case"directional":(t=new o(i)).target.position.set(0,0,-1),t.add(t.target);break;case"point":(t=new n(i)).distance=l;break;case"spot":(t=new a(i)).distance=l,r.spot=r.spot||{},r.spot.innerConeAngle=void 0!==r.spot.innerConeAngle?r.spot.innerConeAngle:0,r.spot.outerConeAngle=void 0!==r.spot.outerConeAngle?r.spot.outerConeAngle:Math.PI/4,t.angle=r.spot.outerConeAngle,t.penumbra=1-r.spot.innerConeAngle/r.spot.outerConeAngle,t.target.position.set(0,0,-1),t.add(t.target);break;default:throw new Error('THREE.GLTFLoader: Unexpected light type, "'+r.type+'".')}return t.position.set(0,0,0),t.decay=2,void 0!==r.intensity&&(t.intensity=r.intensity),t.name=r.name||"light_"+e,Promise.resolve(t)},he.prototype.getMaterialType=function(){return i},he.prototype.extendParams=function(e,t,r){var a=[];e.color=new s(1,1,1),e.opacity=1;var n=t.pbrMetallicRoughness;if(n){if(Array.isArray(n.baseColorFactor)){var o=n.baseColorFactor;e.color.fromArray(o),e.opacity=o[3]}void 0!==n.baseColorTexture&&a.push(r.assignTexture(e,"map",n.baseColorTexture))}return Promise.all(a)},de.prototype.getMaterialType=function(){return l},de.prototype.extendParams=function(e,t,r){var s=[],a=t.extensions[this.name];if(void 0!==a.clearcoatFactor&&(e.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&s.push(r.assignTexture(e,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(e.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&s.push(r.assignTexture(e,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(s.push(r.assignTexture(e,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){var n=a.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new c(n,n)}return Promise.all(s)};var me="glTF",fe=1313821514,ge=5130562;function ve(e){this.name=ce.KHR_BINARY_GLTF,this.content=null,this.body=null;var r=new DataView(e,0,12);if(this.header={magic:t.decodeText(new Uint8Array(e.slice(0,4))),version:r.getUint32(4,!0),length:r.getUint32(8,!0)},this.header.magic!==me)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var s=new DataView(e,12),a=0;a<s.byteLength;){var n=s.getUint32(a,!0);a+=4;var o=s.getUint32(a,!0);if(a+=4,o===fe){var i=new Uint8Array(e,12+a,n);this.content=t.decodeText(i)}else if(o===ge){var l=12+a;this.body=e.slice(l,l+n)}a+=n}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function Te(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=ce.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function ye(){this.name=ce.KHR_TEXTURE_TRANSFORM}function Se(e){u.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),r=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),a=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),n=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),o=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb;","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 );// 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor.rgb;"].join("\n"),i={specular:{value:(new s).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=i,this.onBeforeCompile=function(e){for(var s in i)e.uniforms[s]=i[s];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;"),e.fragmentShader=e.fragmentShader.replace("uniform float metalness;","uniform float glossiness;"),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_pars_fragment>",t),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_pars_fragment>",r),e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_fragment>",a),e.fragmentShader=e.fragmentShader.replace("#include <metalnessmap_fragment>",n),e.fragmentShader=e.fragmentShader.replace("#include <lights_physical_fragment>",o)},Object.defineProperties(this,{specular:{get:function(){return i.specular.value},set:function(e){i.specular.value=e}},specularMap:{get:function(){return i.specularMap.value},set:function(e){i.specularMap.value=e}},glossiness:{get:function(){return i.glossiness.value},set:function(e){i.glossiness.value=e}},glossinessMap:{get:function(){return i.glossinessMap.value},set:function(e){i.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_ROUGHNESSMAP=""):(delete this.defines.USE_ROUGHNESSMAP,delete this.defines.USE_GLOSSINESSMAP)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function Me(){return{name:ce.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return Se},extendParams:function(e,t,r){var a=t.extensions[this.name];e.color=new s(1,1,1),e.opacity=1;var n=[];if(Array.isArray(a.diffuseFactor)){var o=a.diffuseFactor;e.color.fromArray(o),e.opacity=o[3]}if(void 0!==a.diffuseTexture&&n.push(r.assignTexture(e,"map",a.diffuseTexture)),e.emissive=new s(0,0,0),e.glossiness=void 0!==a.glossinessFactor?a.glossinessFactor:1,e.specular=new s(1,1,1),Array.isArray(a.specularFactor)&&e.specular.fromArray(a.specularFactor),void 0!==a.specularGlossinessTexture){var i=a.specularGlossinessTexture;n.push(r.assignTexture(e,"glossinessMap",i)),n.push(r.assignTexture(e,"specularMap",i))}return Promise.all(n)},createMaterial:function(e){var t=new Se(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=p,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function Re(){this.name=ce.KHR_MESH_QUANTIZATION}function xe(e,t,r,s){j.call(this,e,t,r,s)}Te.prototype.decodePrimitive=function(e,t){var r=this.json,s=this.dracoLoader,a=e.extensions[this.name].bufferView,n=e.extensions[this.name].attributes,o={},i={},l={};for(var c in n){var u=Ue[c]||c.toLowerCase();o[u]=n[c]}for(c in e.attributes){u=Ue[c]||c.toLowerCase();if(void 0!==n[c]){var p=r.accessors[e.attributes[c]],h=Pe[p.componentType];l[u]=h,i[u]=!0===p.normalized}}return t.getDependency("bufferView",a).then((function(e){return new Promise((function(t){s.decodeDracoFile(e,(function(e){for(var r in e.attributes){var s=e.attributes[r],a=i[r];void 0!==a&&(s.normalized=a)}t(e)}),o,l)}))}))},ye.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},Se.prototype=Object.create(u.prototype),Se.prototype.constructor=Se,Se.prototype.copy=function(e){return u.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},xe.prototype=Object.create(j.prototype),xe.prototype.constructor=xe,xe.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,r=this.sampleValues,s=this.valueSize,a=e*s*3+s,n=0;n!==s;n++)t[n]=r[a+n];return t},xe.prototype.beforeStart_=xe.prototype.copySampleValue_,xe.prototype.afterEnd_=xe.prototype.copySampleValue_,xe.prototype.interpolate_=function(e,t,r,s){for(var a=this.resultBuffer,n=this.sampleValues,o=this.valueSize,i=2*o,l=3*o,c=s-t,u=(r-t)/c,p=u*u,h=p*u,d=e*l,m=d-l,f=-2*h+3*p,g=h-p,v=1-f,T=g-p+u,y=0;y!==o;y++){var S=n[m+y+o],M=n[m+y+i]*c,R=n[d+y+o],x=n[d+y]*c;a[y]=v*S+T*M+f*R+g*x}return a};var _e=0,Ae=1,Ee=2,we=3,Le=4,be=5,Ie=6,Pe={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Oe={9728:B,9729:f,9984:V,9985:X,9986:z,9987:g},Ce={33071:W,33648:Y,10497:v},He={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Ue={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Ne={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Fe={CUBICSPLINE:void 0,LINEAR:U,STEP:Z},De="OPAQUE",Ge="MASK",ke="BLEND",Ke={"image/png":q,"image/jpeg":T};function je(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function Be(e,t,r){for(var s in r.extensions)void 0===e[s]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[s]=r.extensions[s])}function Ve(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Xe(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var r=0,s=t.weights.length;r<s;r++)e.morphTargetInfluences[r]=t.weights[r];if(t.extras&&Array.isArray(t.extras.targetNames)){var a=t.extras.targetNames;if(e.morphTargetInfluences.length===a.length){e.morphTargetDictionary={};for(r=0,s=a.length;r<s;r++)e.morphTargetDictionary[a[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function ze(e){for(var t="",r=Object.keys(e).sort(),s=0,a=r.length;s<a;s++)t+=r[s]+":"+e[r[s]]+";";return t}function We(e,t,s){this.json=e||{},this.extensions=t||{},this.options=s||{},this.cache=new le,this.primitiveCache={},this.textureLoader=new h(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.fileLoader=new r(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function Ye(e,t,r){var s=t.attributes,a=[];function n(t,s){return r.getDependency("accessor",t).then((function(t){e.setAttribute(s,t)}))}for(var o in s){var i=Ue[o]||o.toLowerCase();i in e.attributes||a.push(n(s[o],i))}if(void 0!==t.indices&&!e.index){var l=r.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));a.push(l)}return Ve(e,t),function(e,t,r){var s=t.attributes,a=new ne;if(void 0!==s.POSITION){var n=(d=r.json.accessors[s.POSITION]).min,o=d.max;if(void 0!==n&&void 0!==o){a.set(new ae(n[0],n[1],n[2]),new ae(o[0],o[1],o[2]));var i=t.targets;if(void 0!==i){for(var l=new ae,c=new ae,u=0,p=i.length;u<p;u++){var h=i[u];if(void 0!==h.POSITION){var d;n=(d=r.json.accessors[h.POSITION]).min,o=d.max;void 0!==n&&void 0!==o?(c.setX(Math.max(Math.abs(n[0]),Math.abs(o[0]))),c.setY(Math.max(Math.abs(n[1]),Math.abs(o[1]))),c.setZ(Math.max(Math.abs(n[2]),Math.abs(o[2]))),l.max(c)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}a.expandByVector(l)}e.boundingBox=a;var m=new oe;a.getCenter(m.center),m.radius=a.min.distanceTo(a.max)/2,e.boundingSphere=m}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}(e,t,r),Promise.all(a).then((function(){return void 0!==t.targets?function(e,t,r){for(var s=!1,a=!1,n=0,o=t.length;n<o;n++){if(void 0!==(c=t[n]).POSITION&&(s=!0),void 0!==c.NORMAL&&(a=!0),s&&a)break}if(!s&&!a)return Promise.resolve(e);var i=[],l=[];for(n=0,o=t.length;n<o;n++){var c=t[n];if(s){var u=void 0!==c.POSITION?r.getDependency("accessor",c.POSITION):e.attributes.position;i.push(u)}if(a){u=void 0!==c.NORMAL?r.getDependency("accessor",c.NORMAL):e.attributes.normal;l.push(u)}}return Promise.all([Promise.all(i),Promise.all(l)]).then((function(t){var r=t[0],n=t[1];return s&&(e.morphAttributes.position=r),a&&(e.morphAttributes.normal=n),e.morphTargetsRelative=!0,e}))}(e,t.targets,r):e}))}function Ze(e,t){var r=e.getIndex();if(null===r){var s=[],a=e.getAttribute("position");if(void 0===a)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var n=0;n<a.count;n++)s.push(n);e.setIndex(s),r=e.getIndex()}var o=r.count-2,i=[];if(t===$)for(n=1;n<=o;n++)i.push(r.getX(0)),i.push(r.getX(n)),i.push(r.getX(n+1));else for(n=0;n<o;n++)n%2==0?(i.push(r.getX(n)),i.push(r.getX(n+1)),i.push(r.getX(n+2))):(i.push(r.getX(n+2)),i.push(r.getX(n+1)),i.push(r.getX(n)));i.length/3!==o&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var l=e.clone();return l.setIndex(i),l}return We.prototype.parse=function(e,t){var r=this,s=this.json,a=this.extensions;this.cache.removeAll(),this.markDefs(),Promise.all([this.getDependencies("scene"),this.getDependencies("animation"),this.getDependencies("camera")]).then((function(t){var n={scene:t[0][s.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:s.asset,parser:r,userData:{}};Be(a,n,s),Ve(n,s),e(n)})).catch(t)},We.prototype.markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],r=this.json.meshes||[],s={},a={},n=0,o=t.length;n<o;n++)for(var i=t[n].joints,l=0,c=i.length;l<c;l++)e[i[l]].isBone=!0;for(var u=0,p=e.length;u<p;u++){var h=e[u];void 0!==h.mesh&&(void 0===s[h.mesh]&&(s[h.mesh]=a[h.mesh]=0),s[h.mesh]++,void 0!==h.skin&&(r[h.mesh].isSkinnedMesh=!0))}this.json.meshReferences=s,this.json.meshUses=a},We.prototype.getDependency=function(e,t){var r=e+":"+t,s=this.cache.get(r);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this.loadNode(t);break;case"mesh":s=this.loadMesh(t);break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this.loadBufferView(t);break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this.loadMaterial(t);break;case"texture":s=this.loadTexture(t);break;case"skin":s=this.loadSkin(t);break;case"animation":s=this.loadAnimation(t);break;case"camera":s=this.loadCamera(t);break;case"light":s=this.extensions[ce.KHR_LIGHTS_PUNCTUAL].loadLight(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(r,s)}return s},We.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var r=this,s=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(s.map((function(t,s){return r.getDependency(e,s)}))),this.cache.add(e,t)}return t},We.prototype.loadBuffer=function(e){var t=this.json.buffers[e],r=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[ce.KHR_BINARY_GLTF].body);var s=this.options;return new Promise((function(e,a){r.load(je(t.uri,s.path),e,void 0,(function(){a(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))},We.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){var r=t.byteLength||0,s=t.byteOffset||0;return e.slice(s,s+r)}))},We.prototype.loadAccessor=function(e){var t=this,r=this.json,s=this.json.accessors[e];if(void 0===s.bufferView&&void 0===s.sparse)return Promise.resolve(null);var a=[];return void 0!==s.bufferView?a.push(this.getDependency("bufferView",s.bufferView)):a.push(null),void 0!==s.sparse&&(a.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),a.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(a).then((function(e){var a,n,o=e[0],i=He[s.type],l=Pe[s.componentType],c=l.BYTES_PER_ELEMENT,u=c*i,p=s.byteOffset||0,h=void 0!==s.bufferView?r.bufferViews[s.bufferView].byteStride:void 0,f=!0===s.normalized;if(h&&h!==u){var g=Math.floor(p/h),v="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+g+":"+s.count,T=t.cache.get(v);T||(a=new l(o,g*h,s.count*h/c),T=new d(a,h/c),t.cache.add(v,T)),n=new Q(T,i,p%h/c,f)}else a=null===o?new l(s.count*i):new l(o,p,s.count*i),n=new m(a,i,f);if(void 0!==s.sparse){var y=He.SCALAR,S=Pe[s.sparse.indices.componentType],M=s.sparse.indices.byteOffset||0,R=s.sparse.values.byteOffset||0,x=new S(e[1],M,s.sparse.count*y),_=new l(e[2],R,s.sparse.count*i);null!==o&&(n=new m(n.array.slice(),n.itemSize,n.normalized));for(var A=0,E=x.length;A<E;A++){var w=x[A];if(n.setX(w,_[A*i]),i>=2&&n.setY(w,_[A*i+1]),i>=3&&n.setZ(w,_[A*i+2]),i>=4&&n.setW(w,_[A*i+3]),i>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return n}))},We.prototype.loadTexture=function(e){var t,r=this,s=this.json,a=this.options,n=this.textureLoader,o=self.URL||self.webkitURL,i=s.textures[e],l=i.extensions||{},c=(t=l[ce.MSFT_TEXTURE_DDS]?s.images[l[ce.MSFT_TEXTURE_DDS].source]:s.images[i.source]).uri,u=!1;return void 0!==t.bufferView&&(c=r.getDependency("bufferView",t.bufferView).then((function(e){u=!0;var r=new Blob([e],{type:t.mimeType});return c=o.createObjectURL(r)}))),Promise.resolve(c).then((function(e){var t=a.manager.getHandler(e);return t||(t=l[ce.MSFT_TEXTURE_DDS]?r.extensions[ce.MSFT_TEXTURE_DDS].ddsLoader:n),new Promise((function(r,s){t.load(je(e,a.path),r,void 0,s)}))})).then((function(e){!0===u&&o.revokeObjectURL(c),e.flipY=!1,i.name&&(e.name=i.name),t.mimeType in Ke&&(e.format=Ke[t.mimeType]);var r=(s.samplers||{})[i.sampler]||{};return e.magFilter=Oe[r.magFilter]||f,e.minFilter=Oe[r.minFilter]||g,e.wrapS=Ce[r.wrapS]||v,e.wrapT=Ce[r.wrapT]||v,e}))},We.prototype.assignTexture=function(e,t,r){var s=this;return this.getDependency("texture",r.index).then((function(a){if(!a.isCompressedTexture)switch(t){case"aoMap":case"emissiveMap":case"metalnessMap":case"normalMap":case"roughnessMap":a.format=T}if(void 0===r.texCoord||0==r.texCoord||"aoMap"===t&&1==r.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+r.texCoord+" for texture "+t+" not yet supported."),s.extensions[ce.KHR_TEXTURE_TRANSFORM]){var n=void 0!==r.extensions?r.extensions[ce.KHR_TEXTURE_TRANSFORM]:void 0;n&&(a=s.extensions[ce.KHR_TEXTURE_TRANSFORM].extendTexture(a,n))}e[t]=a}))},We.prototype.assignFinalMaterial=function(e){var t=e.geometry,r=e.material,s=void 0!==t.attributes.tangent,a=void 0!==t.attributes.color,n=void 0===t.attributes.normal,o=!0===e.isSkinnedMesh,i=Object.keys(t.morphAttributes).length>0,l=i&&void 0!==t.morphAttributes.normal;if(e.isPoints){var c="PointsMaterial:"+r.uuid,u=this.cache.get(c);u||(u=new y,S.prototype.copy.call(u,r),u.color.copy(r.color),u.map=r.map,u.sizeAttenuation=!1,this.cache.add(c,u)),r=u}else if(e.isLine){c="LineBasicMaterial:"+r.uuid;var p=this.cache.get(c);p||(p=new M,S.prototype.copy.call(p,r),p.color.copy(r.color),this.cache.add(c,p)),r=p}if(s||a||n||o||i){c="ClonedMaterial:"+r.uuid+":";r.isGLTFSpecularGlossinessMaterial&&(c+="specular-glossiness:"),o&&(c+="skinning:"),s&&(c+="vertex-tangents:"),a&&(c+="vertex-colors:"),n&&(c+="flat-shading:"),i&&(c+="morph-targets:"),l&&(c+="morph-normals:");var h=this.cache.get(c);h||(h=r.clone(),o&&(h.skinning=!0),s&&(h.vertexTangents=!0),a&&(h.vertexColors=!0),n&&(h.flatShading=!0),i&&(h.morphTargets=!0),l&&(h.morphNormals=!0),this.cache.add(c,h)),r=h}r.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",new m(t.attributes.uv.array,2)),r.normalScale&&!s&&(r.normalScale.y=-r.normalScale.y),r.clearcoatNormalScale&&!s&&(r.clearcoatNormalScale.y=-r.clearcoatNormalScale.y),e.material=r},We.prototype.loadMaterial=function(e){var t,r=this.json,a=this.extensions,n=r.materials[e],o={},l=n.extensions||{},p=[];if(l[ce.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var h=a[ce.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=h.getMaterialType(),p.push(h.extendParams(o,n,this))}else if(l[ce.KHR_MATERIALS_UNLIT]){var d=a[ce.KHR_MATERIALS_UNLIT];t=d.getMaterialType(),p.push(d.extendParams(o,n,this))}else{t=u;var m=n.pbrMetallicRoughness||{};if(o.color=new s(1,1,1),o.opacity=1,Array.isArray(m.baseColorFactor)){var f=m.baseColorFactor;o.color.fromArray(f),o.opacity=f[3]}void 0!==m.baseColorTexture&&p.push(this.assignTexture(o,"map",m.baseColorTexture)),o.metalness=void 0!==m.metallicFactor?m.metallicFactor:1,o.roughness=void 0!==m.roughnessFactor?m.roughnessFactor:1,void 0!==m.metallicRoughnessTexture&&(p.push(this.assignTexture(o,"metalnessMap",m.metallicRoughnessTexture)),p.push(this.assignTexture(o,"roughnessMap",m.metallicRoughnessTexture)))}!0===n.doubleSided&&(o.side=R);var g=n.alphaMode||De;if(g===ke?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,g===Ge&&(o.alphaTest=void 0!==n.alphaCutoff?n.alphaCutoff:.5)),void 0!==n.normalTexture&&t!==i&&(p.push(this.assignTexture(o,"normalMap",n.normalTexture)),o.normalScale=new c(1,1),void 0!==n.normalTexture.scale&&o.normalScale.set(n.normalTexture.scale,n.normalTexture.scale)),void 0!==n.occlusionTexture&&t!==i&&(p.push(this.assignTexture(o,"aoMap",n.occlusionTexture)),void 0!==n.occlusionTexture.strength&&(o.aoMapIntensity=n.occlusionTexture.strength)),void 0!==n.emissiveFactor&&t!==i&&(o.emissive=(new s).fromArray(n.emissiveFactor)),void 0!==n.emissiveTexture&&t!==i&&p.push(this.assignTexture(o,"emissiveMap",n.emissiveTexture)),l[ce.KHR_MATERIALS_CLEARCOAT]){var v=a[ce.KHR_MATERIALS_CLEARCOAT];t=v.getMaterialType(),p.push(v.extendParams(o,{extensions:l},this))}return Promise.all(p).then((function(){var e;return e=t===Se?a[ce.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(o):new t(o),n.name&&(e.name=n.name),e.map&&(e.map.encoding=x),e.emissiveMap&&(e.emissiveMap.encoding=x),Ve(e,n),n.extensions&&Be(a,e,n),e}))},We.prototype.loadGeometries=function(e){var t=this,r=this.extensions,s=this.primitiveCache;function a(e){return r[ce.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(r){return Ye(r,e,t)}))}for(var n,o,i=[],l=0,c=e.length;l<c;l++){var u,p=e[l],h=(o=void 0,(o=(n=p).extensions&&n.extensions[ce.KHR_DRACO_MESH_COMPRESSION])?"draco:"+o.bufferView+":"+o.indices+":"+ze(o.attributes):n.indices+":"+ze(n.attributes)+":"+n.mode),d=s[h];if(d)i.push(d.promise);else u=p.extensions&&p.extensions[ce.KHR_DRACO_MESH_COMPRESSION]?a(p):Ye(new _,p,t),s[h]={primitive:p,promise:u},i.push(u)}return Promise.all(i)},We.prototype.loadMesh=function(e){for(var t,r=this,s=this.json.meshes[e],a=s.primitives,n=[],o=0,i=a.length;o<i;o++){var l=void 0===a[o].material?(void 0===(t=this.cache).DefaultMaterial&&(t.DefaultMaterial=new u({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:J})),t.DefaultMaterial):this.getDependency("material",a[o].material);n.push(l)}return n.push(r.loadGeometries(a)),Promise.all(n).then((function(t){for(var n=t.slice(0,t.length-1),o=t[t.length-1],i=[],l=0,c=o.length;l<c;l++){var u,p=o[l],h=a[l],d=n[l];if(h.mode===Le||h.mode===be||h.mode===Ie||void 0===h.mode)!0!==(u=!0===s.isSkinnedMesh?new A(p,d):new E(p,d)).isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),h.mode===be?u.geometry=Ze(u.geometry,ee):h.mode===Ie&&(u.geometry=Ze(u.geometry,$));else if(h.mode===Ae)u=new w(p,d);else if(h.mode===we)u=new L(p,d);else if(h.mode===Ee)u=new b(p,d);else{if(h.mode!==_e)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);u=new I(p,d)}Object.keys(u.geometry.morphAttributes).length>0&&Xe(u,s),u.name=s.name||"mesh_"+e,o.length>1&&(u.name+="_"+l),Ve(u,s),r.assignFinalMaterial(u),i.push(u)}if(1===i.length)return i[0];var m=new P;for(l=0,c=i.length;l<c;l++)m.add(i[l]);return m}))},We.prototype.loadCamera=function(e){var t,r=this.json.cameras[e],s=r[r.type];if(s)return"perspective"===r.type?t=new O(C.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):"orthographic"===r.type&&(t=new H(s.xmag/-2,s.xmag/2,s.ymag/2,s.ymag/-2,s.znear,s.zfar)),r.name&&(t.name=r.name),Ve(t,r),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")},We.prototype.loadSkin=function(e){var t=this.json.skins[e],r={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(r):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return r.inverseBindMatrices=e,r}))},We.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],r=[],s=[],a=[],n=[],o=[],i=0,l=t.channels.length;i<l;i++){var c=t.channels[i],u=t.samplers[c.sampler],p=c.target,h=void 0!==p.node?p.node:p.id,d=void 0!==t.parameters?t.parameters[u.input]:u.input,m=void 0!==t.parameters?t.parameters[u.output]:u.output;r.push(this.getDependency("node",h)),s.push(this.getDependency("accessor",d)),a.push(this.getDependency("accessor",m)),n.push(u),o.push(p)}return Promise.all([Promise.all(r),Promise.all(s),Promise.all(a),Promise.all(n),Promise.all(o)]).then((function(r){for(var s=r[0],a=r[1],n=r[2],o=r[3],i=r[4],l=[],c=0,u=s.length;c<u;c++){var p=s[c],h=a[c],d=n[c],m=o[c],f=i[c];if(void 0!==p){var g;switch(p.updateMatrix(),p.matrixAutoUpdate=!0,Ne[f.path]){case Ne.weights:g=se;break;case Ne.rotation:g=re;break;case Ne.position:case Ne.scale:default:g=te}var v=p.name?p.name:p.uuid,T=void 0!==m.interpolation?Fe[m.interpolation]:U,y=[];Ne[f.path]===Ne.weights?p.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&y.push(e.name?e.name:e.uuid)})):y.push(v);var S=d.array;if(d.normalized){var M;if(S.constructor===Int8Array)M=1/127;else if(S.constructor===Uint8Array)M=1/255;else if(S.constructor==Int16Array)M=1/32767;else{if(S.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");M=1/65535}for(var R=new Float32Array(S.length),x=0,_=S.length;x<_;x++)R[x]=S[x]*M;S=R}for(x=0,_=y.length;x<_;x++){var A=new g(y[x]+"."+Ne[f.path],h.array,S,T);"CUBICSPLINE"===m.interpolation&&(A.createInterpolant=function(e){return new xe(this.times,this.values,this.getValueSize()/3,e)},A.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(A)}}}var E=t.name?t.name:"animation_"+e;return new N(E,void 0,l)}))},We.prototype.loadNode=function(e){var t,r=this.json,s=this.extensions,a=this,n=r.meshReferences,o=r.meshUses,i=r.nodes[e];return(t=[],void 0!==i.mesh&&t.push(a.getDependency("mesh",i.mesh).then((function(e){var t;if(n[i.mesh]>1){var r=o[i.mesh]++;(t=e.clone()).name+="_instance_"+r}else t=e;return void 0!==i.weights&&t.traverse((function(e){if(e.isMesh)for(var t=0,r=i.weights.length;t<r;t++)e.morphTargetInfluences[t]=i.weights[t]})),t}))),void 0!==i.camera&&t.push(a.getDependency("camera",i.camera)),i.extensions&&i.extensions[ce.KHR_LIGHTS_PUNCTUAL]&&void 0!==i.extensions[ce.KHR_LIGHTS_PUNCTUAL].light&&t.push(a.getDependency("light",i.extensions[ce.KHR_LIGHTS_PUNCTUAL].light)),Promise.all(t)).then((function(e){var t;if((t=!0===i.isBone?new F:e.length>1?new P:1===e.length?e[0]:new D)!==e[0])for(var r=0,a=e.length;r<a;r++)t.add(e[r]);if(i.name&&(t.userData.name=i.name,t.name=G.sanitizeNodeName(i.name)),Ve(t,i),i.extensions&&Be(s,t,i),void 0!==i.matrix){var n=new k;n.fromArray(i.matrix),t.applyMatrix4(n)}else void 0!==i.translation&&t.position.fromArray(i.translation),void 0!==i.rotation&&t.quaternion.fromArray(i.rotation),void 0!==i.scale&&t.scale.fromArray(i.scale);return t}))},We.prototype.loadScene=function(){function e(t,r,s,a){var n=s.nodes[t];return a.getDependency("node",t).then((function(e){return void 0===n.skin?e:a.getDependency("skin",n.skin).then((function(e){for(var r=[],s=0,n=(t=e).joints.length;s<n;s++)r.push(a.getDependency("node",t.joints[s]));return Promise.all(r)})).then((function(r){return e.traverse((function(e){if(e.isMesh){for(var s=[],a=[],n=0,o=r.length;n<o;n++){var i=r[n];if(i){s.push(i);var l=new k;void 0!==t.inverseBindMatrices&&l.fromArray(t.inverseBindMatrices.array,16*n),a.push(l)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[n])}e.bind(new K(s,a),e.matrixWorld)}})),e}));var t})).then((function(t){r.add(t);var o=[];if(n.children)for(var i=n.children,l=0,c=i.length;l<c;l++){var u=i[l];o.push(e(u,t,s,a))}return Promise.all(o)}))}return function(t){var r=this.json,s=this.extensions,a=this.json.scenes[t],n=new P;a.name&&(n.name=a.name),Ve(n,a),a.extensions&&Be(s,n,a);for(var o=a.nodes||[],i=[],l=0,c=o.length;l<c;l++)i.push(e(o[l],n,r,this));return Promise.all(i).then((function(){return n}))}}(),ie}();export{ie as GLTFLoader};
//# sourceMappingURL=GLTFLoader.js.map
